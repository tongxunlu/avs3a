name: 编译av3a-Build and Release AV3AD (Windows)

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+'  # 匹配 v1.0, v1.1 等版本标签
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.0)'
        required: true

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      BUILD_TYPE: Release

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整git历史

    - name: 🏷️ Extract version tag
      id: version
      shell: bash
      run: |
        if [[ ${{ github.event_name }} == 'workflow_dispatch' ]]; then
          echo "::set-output name=version::${{ github.event.inputs.version }}"
        else
          echo "::set-output name=version::${{ github.ref_name }}"
        fi

    - name: 🧰 Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: 🏗️ Configure CMake
      shell: cmd
      run: |
        cmake -S . -B build -G "Visual Studio 17 2022" -A x64 ^
              -DCMAKE_INSTALL_PREFIX=install ^
              -DCMAKE_BUILD_TYPE=%BUILD_TYPE%

    - name: 🔨 Build project
      shell: cmd
      run: cmake --build build --config %BUILD_TYPE% -- /m

    - name: 📦 Install artifacts
      shell: cmd
      run: |
        cmake --install build --config %BUILD_TYPE%
        dir /s install

    - name: 📁 Package release
      shell: cmd
      run: |
        mkdir package
        robocopy install\include package\include /E
        robocopy install\lib package\lib /E
        7z a -tzip av3ad-${{ steps.version.outputs.version }}-win64.zip .\package\*

    - name: ☁️ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: av3ad-${{ steps.version.outputs.version }}-win64
        path: av3ad-${{ steps.version.outputs.version }}-win64.zip

    - name: 🚀 Create Versioned Release
      uses: softprops/action-gh-release@v1
      with:
        name: AV3AD ${{ steps.version.outputs.version }}
        tag_name: ${{ steps.version.outputs.version }}
        files: av3ad-${{ steps.version.outputs.version }}-win64.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
