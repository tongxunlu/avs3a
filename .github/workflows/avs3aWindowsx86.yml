name: Build and Release AV3AD

on:
  push:
    tags:
      - 'v1.0'  # ä¾‹å¦‚ v1.0ã€v2.1.3 ç­‰
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ§° Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential pkg-config mingw-w64

    - name: ğŸ§± Build avs3a for Windows x86
      run: |
        mkdir -p build-avs3a
        cd build-avs3a
        cmake https://github.com/tongxunlu/avs3a \
          -DCMAKE_SYSTEM_NAME=Windows \
          -DCMAKE_C_COMPILER=i686-w64-mingw32-gcc \
          -DCMAKE_CXX_COMPILER=i686-w64-mingw32-g++ \
          -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install/avs3a \
          -DCMAKE_BUILD_TYPE=Release
        cmake --build . --target install --parallel

    - name: ğŸ“ Package avs3a library
      run: |
        mkdir -p package/avs3a
        cp -r install/avs3a/lib package/avs3a/
        cp -r install/avs3a/include package/avs3a/
        # ä½¿ç”¨ç»Ÿä¸€çš„æ–‡ä»¶å
        tar -czvf avs3a-win32.tar.gz -C package/avs3a .

    - name: â˜ï¸ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: avs3a-win32
        path: avs3a-win32.tar.gz

    - name: ğŸš€ Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }}
        tag_name: ${{ github.ref_name }}
        files: avs3a-win32.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
