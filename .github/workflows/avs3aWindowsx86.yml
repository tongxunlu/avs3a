name: Build and Release AVS3A (Windows x86/x64)

on:
  push:
    tags:
      - 'v1.1'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch:
          - x86
          - x64

    steps:
    - name: üì• Checkout workflow repo
      uses: actions/checkout@v4

    - name: üß∞ Install cross-compilation dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake build-essential pkg-config \
          mingw-w64

    - name: üì• Clone avs3a source
      run: git clone https://github.com/tongxunlu/avs3a.git external/avs3a

    - name: üèóÔ∏è Configure CMake for ${{ matrix.arch }}
      run: |
        mkdir -p build-avs3a
        cd build-avs3a

        if [ "${{ matrix.arch }}" = "x86" ]; then
          export CC=i686-w64-mingw32-gcc
          export CXX=i686-w64-mingw32-g++
          export TARGET=win32
        else
          export CC=x86_64-w64-mingw32-gcc
          export CXX=x86_64-w64-mingw32-g++
          export TARGET=win64
        fi

        cmake ../external/avs3a \
          -DCMAKE_SYSTEM_NAME=Windows \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_CXX_COMPILER=$CXX \
          -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install/avs3a \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_SHARED_LIBS=OFF

    - name: üî® Build and Install
      run: |
        cd build-avs3a
        cmake --build . --target install --parallel

    - name: üì¶ Package static library
      run: |
        mkdir -p package
        cp -r install/avs3a/lib package/
        cp -r install/avs3a/include package/
        tar -czvf avs3a-${{ github.ref_name }}-${TARGET}.tar.gz -C package .

    - name: ‚òÅÔ∏è Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: avs3a-${{ github.ref_name }}-${{ matrix.arch }}
        path: avs3a-${{ github.ref_name }}-${{ matrix.arch == 'x86' && 'win32' || 'win64' }}.tar.gz

    - name: üöÄ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }} (Windows)
        tag_name: ${{ github.ref_name }}
        files: |
          avs3a-${{ github.ref_name }}-win32.tar.gz
          avs3a-${{ github.ref_name }}-win64.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
