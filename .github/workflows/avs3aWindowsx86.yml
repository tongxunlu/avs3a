name: Build and Release AVS3A (Windows x86/x64)

on:
  push:
    tags:
      - 'v1.3'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch:
          - x86
          # - x64  # ğŸ“ æš‚æ—¶æ³¨é‡Šæ‰ Windows x64 æ„å»º

    steps:
    - name: ğŸ“¥ Checkout workflow repo
      uses: actions/checkout@v4

    - name: ğŸ§° Install cross-compilation dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake build-essential pkg-config \
          mingw-w64

    - name: ğŸ“¥ Clone avs3a source
      run: git clone https://github.com/tongxunlu/avs3a.git external/avs3a

    - name: ğŸ—ï¸ Configure CMake for ${{ matrix.arch }}
      run: |
        mkdir -p build-avs3a
        cd build-avs3a

        if [ "${{ matrix.arch }}" = "x86" ]; then
          export CC=i686-w64-mingw32-gcc
          export CXX=i686-w64-mingw32-g++
          export TARGET=win32
        # elif [ "${{ matrix.arch }}" = "x64" ]; then
        #   export CC=x86_64-w64-mingw32-gcc
        #   export CXX=x86_64-w64-mingw32-g++
        #   export TARGET=win64
        fi

        cmake ../external/avs3a \
          -DCMAKE_SYSTEM_NAME=Windows \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_CXX_COMPILER=$CXX \
          -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install/avs3a \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_SHARED_LIBS=OFF

    - name: ğŸ”¨ Build and Install
      run: |
        cd build-avs3a
        cmake --build . --target install --parallel

    - name: ğŸ“¦ Package static library
      run: |
        mkdir -p package
        cp -r install/avs3a/lib package/
        cp -r install/avs3a/include package/
        tar -czvf avs3a-${{ github.ref_name }}-${TARGET}.tar.gz -C package .

    - name: â˜ï¸ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: avs3a-${{ github.ref_name }}-${{ matrix.arch }}
        path: avs3a-${{ github.ref_name }}-${{ matrix.arch == 'x86' && 'win32' }}.tar.gz

    - name: ğŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }} (Windows)
        tag_name: ${{ github.ref_name }}
        files: |
          avs3a-${{ github.ref_name }}-win32.tar.gz
          # avs3a-${{ github.ref_name }}-win64.tar.gz  # ğŸ“ æš‚æ—¶æ³¨é‡Šæ‰ x64 å‘å¸ƒ
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
